[[/Utilities/Nsrdb_weather]] -- NSRDB weather data utility

# Synopsis

Shell:

~~~
bash$ gridlabd nsrdb_weather -y|--year=YEARS -p|-position=LAT,LON 
    [-i|--interpolate=MINUTES|METHOD] [-e|--encode=LAT,LON]
    [-g|--glm=GLMNAME] [-n|--name=OBJECTNAME] [-c|--csv=CSVNAME] 
    [--whoami] [--signup=EMAIL] [--apikey[=APIKEY]]
    [--test] [-v|--verbose] [-h|--help|help]
~~~

GLM:

~~~
#python -m nsrdb_weather -y|--year=YEARS -p|-position=LAT,LON 
    [-i|--interpolate=MINUTES|METHOD] [-e|--encode=LAT,LON]
    [-g|--glm=GLMNAME] [-n|--name=OBJECTNAME] [-c|--csv=CSVNAME] 
    [--whoami] [--signup=EMAIL] [--apikey[=APIKEY]]
    [--test] [-v|--verbose] [-h|--help|help]
#include "GLMNAME"
~~~

Python:

~~~
bash$ gridlabd python
>>> import nsrdb_weather as ns
>>> data = ns.getyears(YEARS,LAT,LON)
>>> ns.writeglm(data,GLMNAME,OBJECTNAME,CSVNAME)
~~~

# Description

This module downloads weather data from NSRDB and writes GLM files.  This can
be done from the command line or using call the python API.

Downloaded weather data is for a specified location and year, which must be
provided. The data is downloaded in either 30 or 60 intervals and cached for
later used.  The data that is delivered from the cache can be further
interpolated down to 1 minute.

By default the weather data is output to /dev/stdout.  If the CSV file name 
is specified using `-c|--csv=CSVNAME`, the data will be written to that file.  

If the GLM file name is specified, the CSV file will be formatted for
compatibility with GridLAB-D players and the GLM file will contain a
definition of the weather class, a weather object, and a player object to
feed the weather data in from the CSV.  If the weather object name is not
provided, then the name is automatically generated using a geohash code at
about 2.5 km resolution, e.g., "weather@9q9j6".  To change the geohash
resolution, you must change the `geocode_precision` parameter. To determine
the geohash for a location use the `-e|--encode` option.

The GLM file can be output to "/dev/stdout" for embedding in other GLM files.
For example:

~~~
#include (gridlabd nsrdb_weather -y=2010 -p=37.5,-122.2 -g=/dev/stdout)
~~~

This is equivalent to 

~~~
#python -m nsrdb_weather -y=2010 -p=37.5,-122.2 -g=/tmp/example.glm
#include "/tmp/example.glm"
~~~

without the creation of the temporary file.

The global `${WEATHER}` is set to a space-delimited list of the weather 
objects defined in the GLM file.

## Parameters

The module uses several parameters to control its behavior. 

~~~
leap = True # include leap day in data
interval = 60 # sample interval, may be 30 or 60 minutes
utc = False # timestamps in UTC
email="gridlabd@gmail.com" # credential email
verbose = False # verbose output enable
server = "https://developer.nrel.gov/api/solar/nsrdb_psm3_download.csv" # NSRDB server URL
cachedir = "/usr/local/share/gridlabd/weather" # local NSRDB cache folder
attributes = 'ghi,dhi,dni,cloud_type,dew_point,air_temperature,surface_albedo,wind_speed,wind_direction,solar_zenith_angle' # NSRDB fields to download
credential_file = f"{os.getenv('HOME')}/.nsrdb/credentials.json" # local credential file location
geocode_precision = 5 # about 2.5 km geohash resolution (uses for automatic naming of weather objects)
float_format="%.1f"
~~~

The geocode precisions are roughly as follows:

~~~
1   2,500 km
2   600 km
3   80 km
4   20 km
5   2.5 km
6   200 m
7   80 m
8   20 m
9   2.5 m
10  60 cm
11  7.5 cm
~~~

You can change these options in Python scripts.

~~~
>>> import nsrdb_weather as ns
>>> ns.interval = 30
>>> data = ns.getyear(2014,45.62,-122.70)
~~~

You can permanently change these options by creating the local or shared file
called `nsrdb_weather_config.py`. If found, this file will be imported after
the defaults are set. Note that the default year, position, glm, csv, and name
cannot be changed.

## Credentials

You must obtain an API key from https://developer.nrel.gov/signup/.  Save the key
in the credentials file, which is by default `$HOME/.nsrdb/credentials.json`.

You can run this process in a semi-automated manner using the command

~~~
bash$ gridlabd nsrdb_weather --signup
~~~

with which you can copy and paste a new key in the credential file.

# Caveats

Normally the column units are included in the column names when the CSV file is written. However
when the GLM file is written, the column units are not included in the column names.  The units
are given as part of the `weather` class definition generated by the GLM writer.

# Examples

The following command downloads only the CSV data for a location:

~~~
bash$ gridlabd nsrdb_weather -y=2014,2015 -p=45.62,-122.70 -c=test.csv
~~~

The following command downloads the CSV data and creates a GLM file with the data linked and weather object named:

~~~
bash$ gridlabd nsrdb_weather -y=2014,2015 -p=45.62,-122.70 -c=test.csv -n=test -g=test.glm
~~~

# See also

* [https://nsrdb.nrel.gov/data-sets/api-instructions.html]
