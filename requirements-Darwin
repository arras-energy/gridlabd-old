if [ "$(brew update||echo none)" == "none" ]; then
	ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
	brew doctor
fi

function help-Darwin ()
{
	syntax
	echo "
Commands:
  help
  install
  info
  reinstall
  remove
  upgrade
  verify
"
}

function install-Darwin ()
{
	brew install gnu-sed > /dev/null 
	if [ ! -L /usr/local/bin/sed -o "$(readlink /usr/local/bin/sed)" != "/usr/local/bin/gsed" ]; then 
		sudo ln -s /usr/local/bin/gsed /usr/local/bin/sed
	fi
	export PATH=/usr/local/bin:$PATH
	brew install autoconf > /dev/null 
	brew install automake > /dev/null 
	brew install libtool > /dev/null 
	brew install python3 > /dev/null 
	brew install doxygen > /dev/null
	brew cask install mactex-no-gui > /dev/null
	echo "${OS} ${VER} system ready"

	if [ ! -d /usr/local/src ]; then
		sudo mkdir -p /usr/local/src
	fi
	cd /usr/local/src
	if [ "$PWD" != "/usr/local/src" ]; then
		echo "ERROR: unable to cd to /usr/local/src"
		exit 1
	fi
	touch .tmp-$$ 2>/dev/null
	if [ ! -f .tmp-$$ ]; then
		sudo chmod 777 /usr/local/src
	else
		rm .tmp-$$
	fi
	XERCES=xerces-c-3.2.0
	if [ ! -d ${XERCES} ]; then
		if [ ! -f ${XERCES}.tar.gz ]; then
			curl -L https://archive.apache.org/dist/xerces/c/3/sources/${XERCES}.tar.gz > ${XERCES}.tar.gz || exit 1
		fi
		tar xfz ${XERCES}.tar.gz || exit 1
		rm ${XERCES}.tar.gz
	fi
	echo "${XERCES} download ok"
	cd -

	cd /usr/local/src/${XERCES}
	if [ ! -f Makefile ]; then
		./configure --disable-static 'CFLAGS=-O2' 'CXXFLAGS=-O2' >/dev/null || exit 1
	fi
	make install > /dev/null && echo "${XERCES} installed ok"

	cd /usr/local/src
	MYSQL=mysql-connector-c-6.1.11-macos10.12-x86_64
	if [ ! -d ${MYSQL} ]; then
		if [ ! -f "${MYSQL}.tar.gz" ]; then
			curl -L https://downloads.mysql.com/archives/get/file/${MYSQL}.tar.gz -o ${MYSQL}.tar.gz || exit 1
		fi
		tar xfz ${MYSQL}.tar.gz || exit 1
		rm ${MYSQL}.tar.gz
		sudo cp  ${MYSQL}/bin/* /usr/local/bin || exit 1
		sudo cp -R ${MYSQL}/include/* /usr/local/include || exit 1
		sudo cp -R ${MYSQL}/lib/* /usr/local/lib || exit 1
	fi
	echo "${MYSQL} ok"
	cd -

	cd /usr/local/src
	if [ ! -d /usr/local/src/gridlabd ]; then
		git clone $GITCLONE gridlabd || exit 1
	else
		( cd /usr/local/src/gridlabd ; git pull ) || exit 1
		if [ -f gridlabd/Makefile ]; then
			( cd /usr/local/src/gridlabd; make distclean > /dev/null  )
		fi
	fi
	cd -

	cd /usr/local/src/gridlabd
	autoreconf -isf  > /dev/null || exit 1
	export CFLAGS='-w -O3 -g -I/usr/local/include'
	export CXXFLAGS=$CFLAGS
	./configure --enable-silent-rules --prefix=/usr/local --with-xerces=/usr/local --with-mysql=/usr/local >/dev/null || exit 1
	make -j10 install > /dev/null  || exit 1
	echo "gridlabd installed ok"
	cd -
}

function info-Darwin ()
{
	gridlabd --version
	gridlabd --origin
}

function remove-Darwin ()
{
	cd /usr/local/src/gridlabd
	make uninstall
	cd -
}

function upgrade-Darwin ()
{
	cd /usr/local/src/gridlabd
	git pull
	make clean
	make -j10 install
	cd -
}

function reinstall-Darwin ()
{
	cd /usr/local/src/gridlabd
	git pull
	make distclean
	autoreconf -isf
	./configure --enable-silent-rules --prefix=/usr/local CFLAGS=-w CXXFLAGS=-w
	make -j10 install
	cd -
}

function verify-Darwin ()
{
	gridlabd --validate
}
